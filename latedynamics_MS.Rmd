---
title: "Trajectory analysis"
author: "Rita Grunbreg"
date: "11/09/2021"
output: html_document
---
Metadata for bamboo_community and stentor_community.csv

DATE = observation date

JAR = original microcosm coding where B = Bamboo (assemblage A) and S = Stentor (assemblage B) and R = replicate

JAR2 = microcosms coded numerically

TRT= treatment where 1 = +I/+R, 2 = +I/-R, 3 = -I/-R, 4 = -I/+R, 5 = -R for assemblage A, 
and 6 = +I/+R, 7 = +I/-R, 8= -I/-R, 9= -I/+R, and 10 = -R for assemblage B; 
I = invader, R = resident, + = evolved - = naive

Columns following TRT are the species present in each assemblage. 

For the invader in the control treatment (-R), the period indicates a value of NA from SAS because these treatments lack the invader by design

Prorodon niveus (a resident) failed to establish in the +R/-I treatment and was therefore analyzed separately in all previous analyses (in analyses that drop that treatment)

DATA ARE MEAN COUNTS PER ML
```{r setup,  results='hide', message=FALSE, warning=FALSE}
rm(list = ls())  # clear Rs brain 
library(readr)   # read csv file
library(tidyr)   # tidying data
library(dplyr)   # manipulating df
library(ggplot2) # graphing
library(ggpubr)  # nice package for figures
library(vegan)   # nmds 
library(trend)   # mann-kendell trend test
library(car) #type 3 anovas
library(segmented)#for piecewise regression model
library(nlme) #mixed model to be used in piecewise model 
###############################################################################################################
bamboo_community <- read_csv("C:/Users/grunberg/Documents/GitHub/Late-dynamics/data/bamboo_community.csv")
stentor_community <- read_csv("C:/Users/grunberg/Documents/GitHub/Late-dynamics/data/stentor_community.csv")

set.seed(123456789)
```
Formatting csv files 

Includes making plotting theme and setting color palette
Adding interpretable treatments into data
Calculating days between protists counts 

 Darkest green: +I/+R (Coevolved), RBG 61,91,80, '#3D5B50'
 "darker" medium green: +I/-R (Evolved invaders), RBG 92, 136, 120 "#5C8878"
 medium green: -I/+R (Evolved residents), RBG 126, 156, 76 "#7E9C4C" 
 light green: -I/-R (Naïve invasion)RBG 181, 202, 146 "#B5CA92"
 
```{r bamboo community}
rita_theme <-  theme_classic(base_size = 15)+
  theme(legend.title = element_text(size=7, face="bold"),
        legend.text = element_text(size=6.5),
        legend.position=c(0.15,0.18),
        axis.line = element_line(colour = 'black', size = 0.75),
        axis.ticks = element_line(colour = "black", size = 0.75),
        axis.text.x = element_text(size=12,  colour = "black"), 
        axis.text.y = element_text(size=12,  colour = "black"), # bold
        axis.title.y = element_text(size=14, colour = "black")
  )

#color palette for cara's talk 
colorpal <- c('#3D5B50', "#5C8878","#7E9C4C" , "#B5CA92")

unique(bamboo_community$JAR)

Treatments <- data.frame(TRT = seq(1:5),
                         treat = c("+I/+R", "+I/-R", "-I/-R", "-I/+R", "-R" ),
                         plot.trt = c("Coevolved", "Evolved invader", "Evolved resident", "Naive invasion", "Resident control"))

bamboo_community <- bamboo_community %>%
  mutate(survey_date = as.Date(as.character(DATE), format="%m/%d/%Y"))%>%
  group_by(JAR) %>% arrange(survey_date) %>%
  mutate(BETWEEN0=as.numeric(difftime(survey_date,lag(survey_date,1))),
         BETWEEN=ifelse(is.na(BETWEEN0),0,BETWEEN0),
         FIRST=cumsum(as.numeric(BETWEEN)))%>%
  select(-BETWEEN0)%>%
  drop_na(TRT)

bamboo_community <- merge(bamboo_community, Treatments, by =c("TRT"))
bamboo_community <- bamboo_community %>%   filter(!(treat == "-R")) %>%
  mutate(Euplotes_daidaleos1= as.numeric(Euplotes_daidaleos1)) # remove -R not a good comparison bc lacks invader 
```
Now formatting the stentor commmunity aka assemblage B

Added time of the surveys in days to data frame and treatment names for plotting 

```{r stentor community}
stentor_community <- stentor_community %>%
  mutate(survey_date = as.Date(as.character(DATE), format="%m/%d/%Y"))%>%
  group_by(JAR) %>% arrange(survey_date) %>%
  mutate(BETWEEN0=as.numeric(difftime(survey_date,lag(survey_date,1))),
         BETWEEN=ifelse(is.na(BETWEEN0),0,BETWEEN0),
         FIRST=cumsum(as.numeric(BETWEEN)))%>%
  select(-BETWEEN0)%>%
  drop_na(TRT) %>%
  mutate(TRT = as.numeric(TRT))

unique(stentor_community$JAR)
unique(stentor_community$TRT)

Treatments2 <- data.frame(TRT = c(6,7,8,9,10),
                         treat = c("+I/+R", "+I/-R", "-I/-R", "-I/+R", "-R" ),
                         plot.trt = c("Coevolved", "Evolved invader", "Evolved resident", "Naive invasion", "Resident control"))

stentor_community <- merge(stentor_community, Treatments2, by =c("TRT")) 
stentor_community <- stentor_community %>%   filter(!(treat == "-R"))%>%
  mutate(Paramecium_bursaria2= as.numeric(Paramecium_bursaria2)) # remove -R not a good comparison bc lacks invader 
```
I established patterns of similarity using non-metric multi-dimensional scaling on Bray-Curtis distances. Below is the code to run the ordination and extract relevant information for plotting and analysis 

Note that in Assemblage A we excluded Prorodon from the analysis because it did not establish

```{r NMDS assemblage A}
# create community matrix and envi data matrix 
bamb_mat<-bamboo_community[,c(6:10,12)] # matrix of protist species
bamb_mat_treat<-bamboo_community[,c(1:5, 15:17)] # matrix of treatments

 # global nmds
set.seed(123456789)
 ordO_pt<-metaMDS(bamb_mat, distance="bray", trymax = 500, autotransform=FALSE)
 ordO_pt

 #extract info for plotting
 #add species names to ordination
  species <- c("Blepharisma", "Spirostomum", "Euplotes patella", "Euplotes daidaleos", "Lecane", #"Prorodon",
               "Paramecium bursaria")
  hcoordO<-as.data.frame(scores(ordO_pt, display="sites"))#extracts coordinates for plot
  pcoordO<-scores(ordO_pt, display="species")#extracts coordinates for parasite vectors
  pcoordO <-as.data.frame(pcoordO)
  pcoordO$species <- species
 
  #make dataframe with NMDS coordinates and treatment info 
 bamboo_all <- bind_cols(bamb_mat_treat, hcoordO)
 #write.csv(bamboo_all, "NMDS_coordinates_bamboo_assemblage.csv")
```

Calculate the centroids for analysis and plotting community trjaectories 
```{r bamboo NMDS centroids}
cent.bamboo <- bamboo_all %>%
  group_by(plot.trt, Survey) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean)
```

Graphic of all the data from the NMDS

```{r graphic_NMDS}
topp<-max(bamboo_all[,9:10]) #determines maximum and minimum values for the plot axes
bott<-min(bamboo_all[,9:10]) #I draw from both data sets because I make the graph sqaure and

#jpeg(filename="outplant_NMDS_8removed_BC.jpeg", width=180, height=110, units="mm", bg="white", res=300)
ggplot(bamboo_all, aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_point( size =3,  pch=21, aes(fill=plot.trt))+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  # xlim(c( bott-0.1, topp+0.1)) +
  #ylim(c( bott-0.1, topp+0.1)) +
  scale_fill_manual(values =colorpal)+
  guides(fill=FALSE)+
  theme_pubr() +
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~plot.trt,
             ncol = 2, nrow = 3)+
  guides(fill=FALSE, color=FALSE)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic
#dev.off()
```
Centroids to visualize the trajectories 

```{r graphic_nmds_centroid assemblage A}
topp<-max(cent.bamboo[,3:4]) #determines maximum and minimum values for the plot axes
bott<-min(cent.bamboo[,3:4]) #I draw from both data sets because I make the graph sqaure and

#jpeg(filename="AssemblageA_trajectory.jpeg", width=180, height=180, units="mm", bg="white", res=300)
ggplot(data= cent.bamboo, aes(x= NMDS1, y=NMDS2, fill=plot.trt, group=plot.trt))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_path(color="grey", lwd=1)+
  geom_point( size =6, aes(x= NMDS1, y=NMDS2, fill=plot.trt), pch=21)+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  xlim(c( bott, topp)) +
  ylim(c( bott, topp)) +
  scale_fill_manual(values =colorpal)+
  geom_text( aes(x=NMDS1,y=NMDS2, label=Survey), fontface =2, colour = "black" , size=5) + # plant species label 
  geom_text(aes(x=NMDS1,y=NMDS2, label=Survey), fontface =1, colour = "white" , size=4.5) + # plant species label 
 # geom_text(data=pcoordO, aes(x=NMDS1,y=NMDS2, label=species), fontface =2, colour = "black" , size=2) + # species label 
  theme_pubr() +
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~plot.trt,
             ncol = 2, nrow = 2)+
  guides(fill=FALSE, color=FALSE)+
  ggtitle("Assemblage A")+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic
#dev.off()

```

Below calculates distance between communities for each treatment over time
this will test for convergence between communities 

```{r trajectory}
###################################################################################################
# distance between treatment centroids: how dissimilar are the trajectories btwn groups 
###################################################################################################
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

cent.bamboo <- bamboo_all %>%
  group_by(plot.trt, Survey) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean) 

trt_list <- unique(cent.bamboo$plot.trt)
dist_btw_trt <- data.frame()

for (i in trt_list){
  for(j in trt_list){
    
    treat <- i
    treat2 <- j 
    
    trt_one <- cent.bamboo %>% filter  (plot.trt == i )
    trt_two <- cent.bamboo %>% filter  (plot.trt == j )
    trt_merge <- merge(trt_one, trt_two, by = c("Survey"))
    
    TIME1 <- dist.pt (trt_merge[1,3], trt_merge[1,4],trt_merge[1,6], trt_merge[1,7] )
    TIME2<- dist.pt (trt_merge[2,3], trt_merge[2,4],trt_merge[2,6], trt_merge[2,7] )
    TIME3 <- dist.pt (trt_merge[3,3], trt_merge[3,4],trt_merge[3,6], trt_merge[3,7] )
    TIME4 <- dist.pt (trt_merge[4,3], trt_merge[4,4],trt_merge[4,6], trt_merge[4,7] )
    TIME5 <- dist.pt (trt_merge[5,3], trt_merge[5,4],trt_merge[5,6], trt_merge[5,7] )
    TIME6 <- dist.pt (trt_merge[6,3], trt_merge[6,4],trt_merge[6,6], trt_merge[6,7] )
    TIME7 <- dist.pt (trt_merge[7,3], trt_merge[7,4],trt_merge[7,6], trt_merge[7,7] )
    TIME8 <- dist.pt (trt_merge[8,3], trt_merge[8,4],trt_merge[8,6], trt_merge[8,7] )
    TIME9 <- dist.pt (trt_merge[9,3], trt_merge[9,4],trt_merge[9,6], trt_merge[9,7] )
    
    
    dist_btwn_community <- data.frame(i, j, TIME1, TIME2, TIME3, TIME4, TIME5, TIME6, TIME7, TIME8, TIME9)
    dist_btw_trt <-rbind(dist_btw_trt, dist_btwn_community)
  }
}

col_head <- c('Treat1',"Treat2", '1',"2", "3", "4", "5", "6", "7", "8", "9")
colnames(dist_btw_trt) <- col_head

dist_btw_tidy_1 <- dist_btw_trt %>%
  gather(time, distance, 3:11) %>%
  mutate(type =rep("centroid"))
```

Man kendall trend test to detect trends in convergence or divergence between communities 

```{r man_kendall assemblage A}
###################################################################################################
# trajectory analysis 
###################################################################################################
exptime <- bamboo_community %>% select(Survey, FIRST) %>% group_by(Survey) %>% summarise_all(mean) %>%
  mutate(time = as.character(Survey))
dist_btw_tidy <- merge(dist_btw_tidy_1, exptime, by =c("time"))

mk_cent <- dist_btw_tidy %>% 
  filter(Treat1== "Coevolved") %>%
  filter(Treat2 == "Evolved resident") %>%
  mutate(time = as.numeric(time))%>% arrange(time)

mk_test1 <- mk.test(mk_cent$distance)
mk_slope <- sens.slope(mk_cent$distance)

mk_test1$estimates[3] # extract tau
mk_test1$p.value # extract pvalue from trend test 
mk_slope$estimates # extract slope 
mk_slope$p.value

# okay moving on... 
trt_level_mk_test <- dist_btw_tidy %>% 
  group_by(Treat1, Treat2) %>%  
  mutate(day = as.numeric(FIRST))%>% 
  arrange(day) %>%
  mutate(mann_kendall_tau = mk.test(distance)$estimates[3],
         mann_kendall_pvalue = mk.test(distance)$p.value,
         sens_slope = sens.slope(distance)$estimate,
         sens_pvalue = sens.slope(distance)$p.value) %>%
  group_by(Treat1, Treat2) %>%
  summarise_at(c("mann_kendall_tau", "mann_kendall_pvalue", "sens_slope", "sens_pvalue"), mean)

```
Generates convergence matrix for Assemblage A to quickly see the results and highlight significant trends 

```{r graphic_convergence assemblage A}
converg_matrix <- trt_level_mk_test %>% 
  select(Treat1, Treat2, mann_kendall_tau) %>% # arrange(Treat1) %>% arrange(Treat)%>%
  spread(Treat2, mann_kendall_tau) %>% 
  replace(., is.na(.), 0)

# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}

signif <- trt_level_mk_test %>%
mutate(signif.p = case_when((mann_kendall_pvalue < 0.05) ~ 0, 
                              (mann_kendall_pvalue > 0.05) ~ 1))%>%
  select(Treat1, Treat2, mann_kendall_pvalue, signif.p) 
conv_low <- get_lower_tri(converg_matrix)
convergence <- conv_low %>% 
  gather(Treat2, mann_kendall_tau, 2:5) %>%
  mutate(index = "Bray-Curtis")
convergence <- merge(convergence, signif, by = c("Treat1", "Treat2"))

#jpeg(filename="convergence_AssemblageA.jpeg", width=140, height=120, units="mm", bg="white", res=300)
mktrend <-convergence%>% 
  ggplot(aes(x=Treat1, y = Treat2, fill=mann_kendall_tau))+
  theme_bw(base_size =11.5)+
  geom_raster(aes(x=Treat1, y = Treat2, fill=mann_kendall_tau))+
  scale_fill_gradientn(limits = c(-1,1), 
                       breaks=c(-1,0,1),
                       colours=c('#d53e4f','#ffffbf','#3288bd'),
                       na.value = 'white',
                       name='Tau')+
  labs(x="", y="") +
  geom_text(aes(x=Treat1, y = Treat2, label=round(mann_kendall_tau,2)), size=3, vjust=1)+ 
  geom_text(data=subset(convergence, mann_kendall_pvalue < 0.05), 
            aes(x=Treat1, y = Treat2, label="*"), 
            size=9, color="white", vjust=0.2, hjust=-1)+ 
  geom_text(data=subset(convergence, mann_kendall_tau < -0.9),
            aes(x=Treat1, y = Treat2, label=round(mann_kendall_tau,2)),
            size=10, color="#bdbdbd",  vjust=1)+ 
  theme(axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.justification = c(1, 0),
        legend.position = c(0.5, 0.8),
        legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))+
  guides(fill=FALSE)
mktrend
#dev.off()

```
Example convergence in Assemblage A. See what the distance between communities over time trend looks like 

```{r convergence graphic for significant treatments Assemblage A}
head( dist_btw_tidy)

convergeA <- dist_btw_tidy %>% 
  filter( Treat1 == "Coevolved")%>%
  filter(Treat2 == "Evolved invader") 


#jpeg(filename="convergence_example_AssemblageA.jpeg", width=90, height=90, units="mm", bg="white", res=300)
ggplot(data = convergeA) +
  geom_point(aes(x= as.numeric(FIRST), y = distance), size=4)+
  geom_smooth(method='lm',aes(x= as.numeric(FIRST), y = distance), se=FALSE, col='black')+
  labs(x="days", y="distance between community centroids")+
  ggtitle("Coevolved and evolved invader communities converged in Assemblage A")+
  rita_theme
dev.off()
```
There was a signal of divergence but it was not significant but lets look at it anyway 

```{r non-significant divergence Assemblage A}
head( dist_btw_tidy)

divergeA <- dist_btw_tidy %>% 
  filter( Treat1 == "Coevolved")%>%
  filter(Treat2 == "Evolved resident") 

#jpeg(filename="divergence_example_AssemblageA.jpeg", width=120, height=90, units="mm", bg="white", res=300)
ggplot(data = divergeA) +
  geom_point(aes(x= as.numeric(FIRST), y = distance), size=4)+
  # geom_smooth(method='lm',aes(x= as.numeric(FIRST), y = distance), se=FALSE, col='black')+
  labs(x="days", y="distance between communities")+
  #ggtitle("Coevolved and evolved resident communities converged in Assemblage A")+
  rita_theme
#dev.off()
```
Lets look at all the comparisons (-_-) 

```{r all comparisons}

#jpeg(filename="convergence_allcomparions_AssemblageA.jpeg", width=270, height=270, units="mm", bg="white", res=300)
dist_btw_tidy %>%
  #filter(!(Treat1==Treat2))%>%
  ggplot() +
  geom_point(aes(x= as.numeric(FIRST), y = distance), size=4)+
   geom_smooth(method='lm',aes(x= as.numeric(FIRST), y = distance), se=FALSE, col='black')+
  labs(x="days", y="distance between communities")+
  facet_wrap(~Treat1*Treat2, scales = 'free_y')+
  rita_theme+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15))
#dev.off()
```
Population level analysis using mvabund mixed models 

Exploratory graphics for each species over time 

```{r explore populations changes}
bamboo_community %>% 
  gather(species, abundance, c(6:10,12)) %>%
  filter(species=="Blepharisma")%>%
  ggplot(aes(x=as.factor(Survey), y = log10(abundance+1)), pch=21)+
  labs(x="time", y ="log10 (Blepharisma+1)")+
  geom_boxplot()+rita_theme+facet_wrap(~plot.trt) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15))

bamboo_community %>% 
  gather(species, abundance, c(6:10,12)) %>%
  ggplot(aes(x=(FIRST), y = log10(abundance+1), fill=plot.trt), pch=21)+
  labs(x="time", y ="log10 (abundance+1)")+
  geom_smooth(aes(col=plot.trt), se=FALSE, lwd=2)+
  rita_theme+facet_wrap(~species, scale='free_y') + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15))+
  scale_fill_manual(values=colorpal)+
  scale_color_manual(values=colorpal)+
  theme(legend.title = element_text(size=8.5, face="bold"),
        legend.text = element_text(size=10))+ 
  theme(legend.position="top")+
  guides(color=guide_legend(""), fill=FALSE)

```

```{r mvabund model}
library(mvabund)
species_list <- list(bamboo_community[c(6:10,12)])
treatment <- list(bamboo_community[c(3,17)])
block <- list(bamboo_community[4])

mv.list <-list(species_1 = species_list,
              treatment_1 = treatment, 
              block_1 = block)
attach(mv.list)
species.data <- mvabund(species_1)
is.mvabund(species.data)

#constrain the permutation within a jar by designating shuffletset; 
#nrow = within the abundance data 
#control within jar= block  
permID <- shuffleSet(n=nrow(species.data), nset=99, control=how(block=bamboo_community$JAR))

#community composition analysis
mod1 <- manyglm(species.data ~ as.factor(bamboo_community$Survey)* bamboo_community$plot.trt, family='negative.binomial',
                show.residuals=T)
plot.manyglm(mod1)
summary(mod1)


mod.out <- anova(mod1, bootID=permID, p.uni = 'adjusted', test = 'LR' 
                 )
printCoefmat(mod.out$uni.p)
mod.out
```
```{r model each time point}
mod_pt <- NULL
for (i in levels(factor(bamboo_community$Survey))) {
  take_abu <- species.data[bamboo_community$Survey == i, ]
  take_env <- bamboo_community[bamboo_community$Survey == i, ]
  # model
  mod_pt[[i]]$mod <- manyglm(take_abu ~ plot.trt, family='negative.binomial', data = take_env)
  mod_pt[[i]]$aov <- anova(mod_pt[[i]]$mod, nBoot = 100, 
                           p.uni = 'adjusted', test = 'LR', show.time = "none")
  mod_pt[[i]]$sum <- summary(mod_pt[[i]]$mod, nBoot = 100, 
                             p.uni = 'adjusted', test = 'LR')
}
```
```{r inspect model time}
#mod_pt
```

```{r graph mvabun}
library(reshape)
library(plyr)
devs <- ldply(mod_pt, function(x) x$aov$uni.test[2, ])
plotdf <- melt(devs, id.vars = '.id')

ggplot(plotdf, aes(x = as.numeric(as.character(.id)), y = value, fill = variable)) +
  geom_area(col = 'grey15') + 
 # geom_vline(aes(xintercept = 0)) +
  rita_theme+
  scale_fill_manual(values = c('#ffffcc','#c7e9b4','#7fcdbb',
                               '#41b6c4','#2c7fb8','#253494'),
                    labels = c('Blepharisma', "Spirostomum", "Euplotes patella", 
                               "Euplotes daidaleos", "Lecane", "Paramecium bursaria"))+
  labs(x = 'time', y = 'Deviance (=Effect)')+
  guides(fill=guide_legend("Species"))+
  theme(legend.position="top")
```
```{r boral for assemblag A}
library(mvabund)
library(boral)

spp.y <- bamboo_community[c(6:10,12)]
fit.lvmp <- boral(y= spp.y,
                  family = "poisson",
                  row.eff = "fixed")

```
Now doing the NMDS for assemblage B

```{r NMDS assemblage B}
# create community matrix and envi data matrix 
stent_mat<-stentor_community[,c(6:10)] # matrix of protist species
stent_mat_treat<-stentor_community[,c(1:5, 16:18)] # matrix of treatments

#standardize values to unit maximum 
#bamb_standardized<-apply((bamb_mat),2, function(x) x/max(x)) #exclude epichloe 

 # global nmds
set.seed(123456789)
 ordO_pt<-metaMDS(stent_mat, distance="bray", trymax = 500, autotransform=FALSE)
 ordO_pt

 #extract info for plotting
  species2 <- c("Stentor","Paramecium caudatum", "Monostyla", "Euplotes diadaelos", "Paramecium bursaria")
  hcoordO<-as.data.frame(scores(ordO_pt, display="sites"))#extracts coordinates for plot
  pcoordO<-scores(ordO_pt, display="species")#extracts coordinates for parasite vectors
  pcoordO <-as.data.frame(pcoordO)
  pcoordO$species <- species2
 
 stentor_all <- bind_cols(stent_mat_treat, hcoordO)
 #write.csv(bamboo_all, "NMDS_coordinates_bamboo_assemblage.csv")
```
Call:
metaMDS(comm = stent_mat, distance = "bray", trymax = 500, autotransform = FALSE) 

global Multidimensional Scaling using monoMDS

Data:     stent_mat 
Distance: bray 

Dimensions: 2 
Stress:     0.1354263 
Stress type 1, weak ties
Two convergent solutions found after 20 tries
Scaling: centring, PC rotation, halfchange scaling 
Species: expanded scores based on ‘stent_mat’


```{r assemblage B NMDS centroids}
cent.stent <- stentor_all %>%
  group_by(plot.trt, Survey) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean)
#cent <-aggregate(scrsparasite ~ Treat + Survey.event, data = parasite_all, FUN = "mean")

#extract 95% CI
#ci95 <- function(z) qt(0.025,df=length(z)-1, lower.tail=F)* sd(z)/sqrt(length(z)) 
#cent.95<- aggregate(scrsparasite ~ Treat + Survey.event,data=parasite_all,ci95)

#cent <- merge(cent, cent.95, by = c("Treat", "Survey.event"))
```
Try renaming the labels for the facet wrap 


```{r graphic_NMDS}
topp<-max(stentor_all[,9:10]) #determines maximum and minimum values for the plot axes
bott<-min(stentor_all[,9:10]) #I draw from both data sets because I make the graph sqaure and

#jpeg(filename="assemblageB_NMDS_alldata.jpeg", width=180, height=110, units="mm", bg="white", res=300)
ggplot(stentor_all, aes(x= NMDS1, y=NMDS2, fill=plot.trt))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_point( size =3,  pch=21)+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  # xlim(c( bott-0.1, topp+0.1)) +
  #ylim(c( bott-0.1, topp+0.1)) +
  theme_pubr() +
  scale_fill_manual(values =colorpal)+
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~plot.trt,
             ncol = 2, nrow = 2)+
  guides(fill=FALSE, color=FALSE)+
 # geom_text(data=pcoordO, aes(x=NMDS1,y=NMDS2, label=parasite), fontface =1, colour = "black" , size=4) + # plant species label 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic
#dev.off()
```

```{r graphic_nmds_centroid}
topp<-max(cent.stent[,3:4]) #determines maximum and minimum values for the plot axes
bott<-min(cent.stent[,3:4]) #I draw from both data sets because I make the graph sqaure and

#jpeg(filename="AssemblageB_trajectory.jpeg", width=180, height=180, units="mm", bg="white", res=300)
ggplot(cent.stent, aes(x= NMDS1, y=NMDS2))+
  geom_hline(yintercept = 0, lty=2, color="grey") +
  geom_vline(xintercept = 0, lty=2, color="grey") +
  geom_path(#aes(color=Treat),
    color="grey", lwd=1)+
  #geom_line(aes(color=Treat), lwd=1.5)+
  geom_point(size =6, aes(fill=plot.trt),
             pch=21)+
  xlab("NMDS 1") +
  ylab("NMDS 2") +
  xlim(c( bott, topp)) +
  ylim(c( bott, topp)) +
  scale_fill_manual(values =colorpal)+
  # geom_text(data=pcoordO, aes(x=NMDS1,y=NMDS2, label=parasite), fontface =2, colour = "black" , size=2) + # parasite species label 
  geom_text(aes(x=NMDS1,y=NMDS2, label=Survey), fontface =2, colour = "black" , size=5) + # plant species label 
  geom_text(aes(x=NMDS1,y=NMDS2, label=Survey), fontface =1, colour = "white" , size=4.5) + # plant species label 
  theme_pubr() +
  theme(legend.text = element_text(size=8), legend.box = "horizontal",
        legend.title = element_text(size=9, face="bold"),
        legend.position=c(0.13,0.85)) +
  guides(colour = guide_legend(override.aes = list(size=70)))+
  theme(plot.title = element_text(hjust = 0.5, size=15, face="bold")) + # guides(shape=FALSE)+ 
  facet_wrap(~plot.trt,
             ncol = 2, nrow = 2)+
  guides(fill=FALSE, color=FALSE)+
  ggtitle("Assemblage B")+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic

#dev.off()
```

```{r permanova for assemblage b}
out.perm2<-adonis(formula=stent_mat ~ treat *Survey , 
                     strata =stent_mat_treat$JAR,
                     data=bamb_mat_treat, 
                     permutations=999,
                     method="bray")
out.perm2
```

Call:
adonis(formula = stent_mat ~ treat * Survey, data = bamb_mat_treat,      permutations = 999, method = "bray", strata = stent_mat_treat$JAR) 

Blocks:  strata 
Permutation: free
Number of permutations: 999

Terms added sequentially (first to last)

              Df SumsOfSqs MeanSqs F.Model      R2 Pr(>F)    
treat          3    3.1832 1.06108 15.5534 0.20363  0.002 ** 
Survey         1    0.4176 0.41763  6.1217 0.02672  0.001 ***
treat:Survey   3    0.2975 0.09917  1.4537 0.01903  0.090 .  
Residuals    172   11.7342 0.06822         0.75062           
Total        179   15.6326                 1.00000           
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

```{r permanova pairwise}
# Benjamini and Hochberg  = fdr; can use method="bonferroni" for more conservative test 
pairwise.adonis <- function(x,factors, sim.method = 'bray', p.adjust.m ='fdr')
  {
  library(vegan)
  co = combn(unique(factors),2)
  pairs = c()
  F.Model =c() 
  R2 = c()
  p.value = c()
  for(elem in 1:ncol(co)){
    ad = adonis(x[factors %in% c(co[1,elem],co[2,elem]),] ~ factors[factors %in% c(co[1,elem],co[2,elem])] , method =sim.method);
    pairs = c(pairs,paste(co[1,elem],'vs',co[2,elem]));
    F.Model =c(F.Model,ad$aov.tab[1,4]);
    R2 = c(R2,ad$aov.tab[1,5]);
    p.value = c(p.value,ad$aov.tab[1,6])
    }
  p.adjusted = p.adjust(p.value,method=p.adjust.m)
  pairw.res = data.frame(pairs,F.Model,R2,p.value,p.adjusted)
  return(pairw.res)
}

out.pair<-pairwise.adonis(bamb_mat, bamb_mat_treat$treat)
out.pair<- data.frame(out.pair)

pdjust.treat <- out.pair %>% 
  separate(pairs, c("contrast1", "contrast2"), "vs")%>% 
  dplyr::select(contrast1, contrast2, p.adjusted) %>%
  spread(contrast2, p.adjusted, fill = NA)
```
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 Benjamini and Hochberg CORRECT PVALUES  
                                                  pairs    F.Model           R2 p.value  p.adjusted
1                   Epi (+) vs Epi (+) Col (+) Rhiz (+) 6.77095471 1.229359e-02   0.001 0.004666667
2                                    Epi (+) vs Epi (-) 0.76159969 1.780430e-03   0.477 0.534240000
3                           Epi (+) vs Epi (-) Rhiz (+) 0.17044356 3.990060e-04   0.850 0.881481481
4                            Epi (+) vs Epi (-) Col (+) 6.50352761 1.415338e-02   0.005 0.015555556
5                           Epi (+) vs Epi (+) Rhiz (+) 3.99578986 7.291643e-03   0.006 0.016800000
6                            Epi (+) vs Epi (+) Col (+) 0.96473997 1.770280e-03   0.391 0.476000000
7                   Epi (+) vs Epi (-) Col (+) Rhiz (+) 3.23968600 7.309106e-03   0.043 0.080266667
8                   Epi (+) Col (+) Rhiz (+) vs Epi (-) 8.46358942 1.943581e-02   0.001 0.004666667
9          Epi (+) Col (+) Rhiz (+) vs Epi (-) Rhiz (+) 2.67190374 6.218474e-03   0.062 0.108500000
10          Epi (+) Col (+) Rhiz (+) vs Epi (-) Col (+) 4.68989058 1.024687e-02   0.009 0.021000000
11         Epi (+) Col (+) Rhiz (+) vs Epi (+) Rhiz (+) 2.19516378 4.019010e-03   0.084 0.130666667
12          Epi (+) Col (+) Rhiz (+) vs Epi (+) Col (+) 6.03956017 1.098023e-02   0.002 0.007000000
13 Epi (+) Col (+) Rhiz (+) vs Epi (-) Col (+) Rhiz (+) 5.79399527 1.299702e-02   0.007 0.017818182
14                          Epi (-) vs Epi (-) Rhiz (+) 0.82062331 2.640183e-03   0.463 0.534240000
15                           Epi (-) vs Epi (-) Col (+) 7.33344345 2.135954e-02   0.001 0.004666667
16                          Epi (-) vs Epi (+) Rhiz (+) 3.50034693 8.130881e-03   0.013 0.028000000
17                           Epi (-) vs Epi (+) Col (+) 2.02125922 4.711326e-03   0.149 0.208600000
18                  Epi (-) vs Epi (-) Col (+) Rhiz (+) 3.90329157 1.194020e-02   0.021 0.042000000
19                  Epi (-) Rhiz (+) vs Epi (-) Col (+) 2.17190341 6.422483e-03   0.082 0.130666667
20                 Epi (-) Rhiz (+) vs Epi (+) Rhiz (+) 1.13413614 2.649021e-03   0.337 0.428909091
21                  Epi (-) Rhiz (+) vs Epi (+) Col (+) 1.56055491 3.641387e-03   0.194 0.258666667
22         Epi (-) Rhiz (+) vs Epi (-) Col (+) Rhiz (+) 2.40377308 7.387047e-03   0.091 0.134105263
23                  Epi (-) Col (+) vs Epi (+) Rhiz (+) 0.82370834 1.815040e-03   0.506 0.544923077
24                   Epi (-) Col (+) vs Epi (+) Col (+) 8.85847253 1.918006e-02   0.001 0.004666667
25          Epi (-) Col (+) vs Epi (-) Col (+) Rhiz (+) 9.73259495 2.713050e-02   0.001 0.004666667
26                  Epi (+) Rhiz (+) vs Epi (+) Col (+) 5.47355454 9.961452e-03   0.002 0.007000000
27         Epi (+) Rhiz (+) vs Epi (-) Col (+) Rhiz (+) 6.14847894 1.378124e-02   0.001 0.004666667
28          Epi (+) Col (+) vs Epi (-) Col (+) Rhiz (+) 0.01201477 2.730555e-05   0.931 0.931000000
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```{r trajectory}
###################################################################################################
# distance between treatment centroids: how dissimilar are the trajectories btwn groups 
###################################################################################################
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

cent.stent <- stentor_all %>%
  group_by(plot.trt, Survey) %>%
  summarise_at(c("NMDS1", 'NMDS2'), mean) 

trt_list <- unique(cent.stent$plot.trt)
dist_btw_trt <- data.frame()

for (i in trt_list){
  for(j in trt_list){
    
    treat <- i
    treat2 <- j 
    
    trt_one <- cent.stent %>% filter  (plot.trt == i )
    trt_two <- cent.stent %>% filter  (plot.trt == j )
    trt_merge <- merge(trt_one, trt_two, by = c("Survey"))
    
    TIME1 <- dist.pt (trt_merge[1,3], trt_merge[1,4],trt_merge[1,6], trt_merge[1,7] )
    TIME2<- dist.pt (trt_merge[2,3], trt_merge[2,4],trt_merge[2,6], trt_merge[2,7] )
    TIME3 <- dist.pt (trt_merge[3,3], trt_merge[3,4],trt_merge[3,6], trt_merge[3,7] )
    TIME4 <- dist.pt (trt_merge[4,3], trt_merge[4,4],trt_merge[4,6], trt_merge[4,7] )
    TIME5 <- dist.pt (trt_merge[5,3], trt_merge[5,4],trt_merge[5,6], trt_merge[5,7] )
    TIME6 <- dist.pt (trt_merge[6,3], trt_merge[6,4],trt_merge[6,6], trt_merge[6,7] )
    TIME7 <- dist.pt (trt_merge[7,3], trt_merge[7,4],trt_merge[7,6], trt_merge[7,7] )
    TIME8 <- dist.pt (trt_merge[8,3], trt_merge[8,4],trt_merge[8,6], trt_merge[8,7] )
    TIME9 <- dist.pt (trt_merge[9,3], trt_merge[9,4],trt_merge[9,6], trt_merge[9,7] )
    
    
    dist_btwn_community <- data.frame(i, j, TIME1, TIME2, TIME3, TIME4, TIME5, TIME6, TIME7, TIME8, TIME9)
    dist_btw_trt <-rbind(dist_btw_trt, dist_btwn_community)
  }
}

col_head <- c('Treat1',"Treat2", '1',"2", "3", "4", "5", "6", "7", "8", "9")
colnames(dist_btw_trt) <- col_head

dist_btw_tidy_stent1 <- dist_btw_trt %>%
  gather(time, distance, 3:11) %>%
  mutate(type =rep("centroid"))

```

Man Kendall trend test on assemblage B 

```{r man_kendall}

exptime <- stentor_community %>% select(Survey, FIRST) %>% group_by(Survey) %>% summarise_all(mean) %>%
  mutate(time = as.character(Survey))
dist_btw_tidy_stent <- merge(dist_btw_tidy_stent1, exptime, by =c("time"))

mk_cent <- dist_btw_tidy_stent %>% 
  filter(Treat1== "Coevolved") %>%
  filter(Treat2 == "Naive invasion") %>%
  mutate(time = as.numeric(time))%>% arrange(time)

mk_test1 <- mk.test(mk_cent$distance)
mk_slope <- sens.slope(mk_cent$distance)

mk_test1$estimates[3] # extract tau
mk_test1$p.value # extract pvalue from trend test 
mk_slope$estimates # extract slope 
mk_slope$p.value

# okay moving on... 
trt_level_mk_test_stent <- dist_btw_tidy_stent %>% 
  group_by(Treat1, Treat2) %>%  
  mutate(time = as.numeric(time))%>% 
  arrange(time) %>%
  mutate(mann_kendall_tau = mk.test(distance)$estimates[3],
         mann_kendall_pvalue = mk.test(distance)$p.value,
         sens_slope = sens.slope(distance)$estimate,
         sens_pvalue = sens.slope(distance)$p.value) %>%
  group_by(Treat1, Treat2) %>%
  summarise_at(c("mann_kendall_tau", "mann_kendall_pvalue", "sens_slope", "sens_pvalue"), mean)

```

```{r graphic_convergence for assemblage B}
converg_matrix <- trt_level_mk_test_stent %>% 
  select(Treat1, Treat2, mann_kendall_tau) %>% # arrange(Treat1) %>% arrange(Treat)%>%
  spread(Treat2, mann_kendall_tau) %>% 
  replace(., is.na(.), 0)

# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}

signif <- trt_level_mk_test_stent %>%
mutate(signif.p = case_when((mann_kendall_pvalue < 0.05) ~ 0, 
                              (mann_kendall_pvalue > 0.05) ~ 1))%>%
  select(Treat1, Treat2, mann_kendall_pvalue, signif.p) 
conv_low <- get_lower_tri(converg_matrix)
convergence <- conv_low %>% 
  gather(Treat2, mann_kendall_tau, 2:5) %>%
  mutate(index = "Bray-Curtis")
convergence <- merge(convergence, signif, by = c("Treat1", "Treat2"))

#jpeg(filename="convergence_assemblageB.jpeg", width=140, height=120, units="mm", bg="white", res=300)
mktrend_stentor <-convergence%>% 
  ggplot(aes(x=Treat1, y = Treat2, fill=mann_kendall_tau))+
  theme_bw(base_size =11.5)+
  geom_raster(aes(x=Treat1, y = Treat2, fill=mann_kendall_tau))+
  scale_fill_gradientn(limits = c(-1,1), 
                       breaks=c(-1,0,1),
                       colours=c('#d53e4f','#ffffbf','#3288bd'),
                       na.value = 'white',
                       name='Tau')+
  labs(x="", y="") +
  geom_text(aes(x=Treat1, y = Treat2, label=round(mann_kendall_tau,2)), size=3, vjust=1)+ 
  geom_text(data=subset(convergence, mann_kendall_pvalue < 0.05), 
            aes(x=Treat1, y = Treat2, label="*"), 
            size=9, color="white", vjust=0.2, hjust=-1)+ 
  geom_text(data=subset(convergence, mann_kendall_tau < -0.9),
            aes(x=Treat1, y = Treat2, label=round(mann_kendall_tau,2)),
            size=10, color="#bdbdbd",  vjust=1)+ 
  theme(axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        #  axis.ticks.x=element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        # panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.justification = c(1, 0),
        legend.position = c(0.5, 0.8),
        legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))+
  guides(fill=FALSE)

mktrend_stentor
#dev.off()

```

Graphic example of significant convergence in assemblage B 

```{r convergence graphic for significant treatments Assemblage B}
head( dist_btw_tidy_stent)

#jpeg(filename="convergence_example_AssemblageB.jpeg", width=120, height=90, units="mm", bg="white", res=300)
dist_btw_tidy_stent %>% 
  filter( Treat1 == "Evolved resident")%>%
  filter(Treat2 == "Naive invasion") %>% ggplot()+
  geom_point(aes(x= as.numeric(FIRST), y = distance), size=4)+
  geom_smooth(method='lm',aes(x= as.numeric(FIRST), y = distance), se=FALSE, col='black')+
  labs(x="days", y="distance between communities")+
 # ggtitle("Evolved resident and naive invasion communities converged in Assemblage A")+
  rita_theme
#dev.off()
```

```{r assemblageB convergence}
#jpeg(filename="convergence_allcomparions_Assemblageb.jpeg", width=270, height=270, units="mm", bg="white", res=300)
dist_btw_tidy_stent %>%
  #filter(!(Treat1==Treat2))%>%
  ggplot() +
  geom_point(aes(x= as.numeric(FIRST), y = distance), size=4)+
   geom_smooth(method='lm',aes(x= as.numeric(FIRST), y = distance), se=FALSE, col='black')+
  labs(x="days", y="distance between communities")+
  facet_wrap(~Treat1*Treat2, scales = 'free_y')+
  rita_theme+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15))
#dev.off()
```

To assess drift within a treatment, I calculated the distance from the centroid for each outplant within a treatment group.   

```{r drift}
###################################################################################################
# calculate distance between communities and their centroid
dist.pt <- function(x1, y1, x2, y2) sqrt((x2-x1)^2 + (y2-y1)^2) # finds distance between points 

jar_list <- unique(bamboo_community$JAR)

bamboo_nmds <- merge(bamboo_all, cent.bamboo, by =c ("plot.trt", "Survey"))

dis_centroid <- data.frame()

for (i in jar_list){

    jar <- i
    
   # trt_merge <- bamboo_nmds %>% filter(JAR=="B1R1") %>% arrange(Survey)
    trt_merge <- bamboo_nmds %>% 
      filter  (JAR== i)%>%
      arrange(Survey)
    
    TIME1 <- dist.pt (trt_merge[1,9], trt_merge[1,10],trt_merge[1,11], trt_merge[1,12] )
    TIME2 <- dist.pt (trt_merge[2,9], trt_merge[2,10],trt_merge[2,11], trt_merge[2,12] )
    TIME3 <- dist.pt (trt_merge[3,9], trt_merge[3,10],trt_merge[3,11], trt_merge[3,12] )
    TIME4 <- dist.pt (trt_merge[4,9], trt_merge[4,10],trt_merge[4,11], trt_merge[4,12] )
    TIME5 <- dist.pt (trt_merge[5,9], trt_merge[5,10],trt_merge[5,11], trt_merge[5,12] )
    TIME6 <- dist.pt (trt_merge[6,9], trt_merge[6,10],trt_merge[6,11], trt_merge[6,12] )
    TIME7 <- dist.pt (trt_merge[7,9], trt_merge[7,10],trt_merge[7,11], trt_merge[7,12] )
    TIME8 <- dist.pt (trt_merge[8,9], trt_merge[8,10],trt_merge[8,11], trt_merge[8,12] )
    TIME9 <- dist.pt (trt_merge[9,9], trt_merge[9,10],trt_merge[9,11], trt_merge[9,12] )
    
    dist_btwn_jar <- data.frame(i,trt_merge$plot.trt, 
                                  TIME1, TIME2, TIME3, TIME4, 
                                TIME5, TIME6, TIME7, 
                                  TIME8, TIME9)
    dis_centroid <-rbind(dis_centroid, dist_btwn_jar)

}

col_head <- c('JAR',
              "plot.trt", 
              '1',"2", "3", "4", "5", "6", "7",
              "8", "9")
colnames(dis_centroid) <- col_head

distance_centroid <- dis_centroid %>%
  group_by(JAR, plot.trt) %>%
  summarise_all(mean) %>%
  gather(time, Distance,3:11
         )%>%
  drop_na()
```

Visualize distance from centroid over time
```{r drift graphic}

distance_centroid %>% ggplot()+
  geom_boxplot(aes(x=as.factor(time), y = Distance, fill=plot.trt))+ 
  facet_wrap(~plot.trt)+
  labs(x="time", y = "distance to centroid")+
  rita_theme+
  guides(fill=FALSE)+
  scale_fill_manual(values=colorpal)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1),
        strip.text = element_text(size = 15)) # add black square panel around graphic

```

```{r segmented model}
library(lmerTest)

cent.model <-lmer(log10(Distance+1) ~ as.numeric(time) * plot.trt + (1|JAR), data= distance_centroid) #random intercept
summary(cent.model)
```
